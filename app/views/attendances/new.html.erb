<h1>勤怠CSVアップロード</h1>

<%= form_with url: attendances_path, method: :post, local: true, data: { turbo: false }, html: { multipart: true } do |f| %>
  <% if @form.errors.any? %>
    <ul style="color: red;">
      <% @form.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
    </ul>
  <% end %>

  <%= file_field_tag :csv_file %>
  <%= submit_tag "アップロード" %>
<% end %>

<% if @results.present? %>
  <h2>集計結果</h2>
  <table>
    <thead>
      <tr><th>日付</th><th>出勤</th><th>退勤</th><th>労働時間</th></tr>
    </thead>
    <tbody>
      <% @results.each do |r| %>
        <tr>
          <td><%= r[:date] %></td>
          <td><%= r[:start] %></td>
          <td><%= r[:end] %></td>
          <td><%= r[:hours] %> 時間</td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<% if @form.row_errors.present? %>
  <div style="color: red;">
    <h3>読み込めなかった行（スキップされました）:</h3>
    <ul>
      <% @form.row_errors.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<% if @monthly_average.present? %>
  <h2>月別労働時間（合計・平均）</h2>
  <table>
    <thead>
      <tr><th>年月</th><th>合計労働時間</th><th>平均労働時間</th></tr>
    </thead>
    <tbody>
      <% @monthly_average.each do |month, data| %>
        <tr>
          <td><%= month %></td>
          <td><%= data[:total] %> 時間</td>
          <td><%= data[:average] %> 時間</td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
